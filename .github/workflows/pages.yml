name: Build and deploy to GitHub Pages (gh-pages)
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Cleanup previous deploy worktree (if any)
        run: |
          set -e
          TEMP_FOLDER="github-pages-deploy-action-temp-deployment-folder"
          # If a previous worktree exists, try removing it; otherwise remove any leftover folder
          if git worktree list | grep -q "$TEMP_FOLDER"; then
            git worktree remove "$TEMP_FOLDER" || true
          fi
          rm -rf "$TEMP_FOLDER" || true

      - name: Deploy to gh-pages branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: dist
          token: ${{ secrets.PAGES_PAT }}
          singleCommit: true

      - name: Ensure Pages site is configured and built
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PAGES_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            core.info(`Configuring Pages for ${owner}/${repo} -> gh-pages / root`);
            // Request Pages site creation/configuration
            await github.rest.repos.createPagesSite({
              owner,
              repo,
              source: { branch: 'gh-pages', path: '/' }
            });

            // Poll until the Pages site is built or timeout
            const maxAttempts = 20;
            const delay = ms => new Promise(res => setTimeout(res, ms));
            for (let i = 0; i < maxAttempts; i++) {
              try {
                const resp = await github.rest.repos.getPages({ owner, repo });
                const status = resp.data?.status || resp.data?.page?.status || resp.data?.html_url;
                core.info(`Pages status (attempt ${i+1}): ${JSON.stringify(resp.data)}`);
                if (resp.data && (resp.data.status === 'built' || resp.data.html_url)) {
                  core.info('Pages site is configured and (likely) built.');
                  break;
                }
              } catch (err) {
                core.info(`Pages not ready yet: ${err.message}`);
              }
              await delay(5000);
            }

      - name: 'Diagnostic: Pages API check (uses PAGES_PAT)'
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          echo "=== Pages API GET (check current) ==="
            # Request current Pages config
            curl -sS \
              -H "Authorization: token $PAGES_PAT" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/pages" -o /tmp/pages_resp || true
          echo "GET response (first 4k bytes):"
          head -c 4096 /tmp/pages_resp || true
          echo
          echo "=== Pages API POST (attempt create/configure) ==="
              # Attempt to create/configure Pages (will show permission errors if any)
              curl -sS -X POST \
                -H "Authorization: token $PAGES_PAT" \
                -H "Accept: application/vnd.github.v3+json" \
                -H "Content-Type: application/json" \
                --data '{"source":{"branch":"gh-pages","path":"/"}}' \
                "https://api.github.com/repos/${{ github.repository }}/pages" -o /tmp/pages_post_resp || true
          echo "POST response (first 4k bytes):"
          head -c 4096 /tmp/pages_post_resp || true
